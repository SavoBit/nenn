{% extends "syntax_highlight.html" %}

{% block headerkludge %}
<nav class="breadcrumb" aria-label="breadcrumbs">
  <ul>
    <li><a href="{{ url('home') }}">Home</a></li>
    <li><a href="{{ url('exercises') }}">Exercises</a></li>
    <li class="is-active"><a href="#" aria-current="page">Insecure Deserialization</a></li>
  </ul>
</nav>
{% endblock %}

{% block content %}
<div class="box">
  <h3 class="title">Restore User Profile</h3>

  <p class="content">Here's a vulnerable user data restore function, and the backing source.
  Can you exploit the handler to run arbitrary code?
  </p>

  <form class="box" action="{{ url('deserialize-user') }}" method="POST" enctype="multipart/form-data">
    <div class="field is-grouped">
      <div class="control file has-name">
        <label class="file-label">
          <input class="file-input" type="file" name="profile">
          <span class="file-cta">
            <span class="file-icon">
              <i class="fas fa-upload"></i>
            </span>
            <span class="file-label">
              Choose a fileâ€¦
            </span>
          </span>
          <span class="file-name">
            user.backup
          </span>
        </label>
      </div>
      <div class="control">
        <button name="submit" class="button is-link">Restore</button>
      </div>
    </div>
  </form>

  <pre><code>
def deserialize_user(request):
    try:
        profile = request.FILES['profile'].read()
        data = pickle.loads(codecs.decode(profile, 'base64'))
        user = auth.models.User.objects.get(username=data['username'])
    except auth.models.User.DoesNotExist:
        # Restore the backup
        user = auth.models.User.create(**data)
    except Exception as e:
        return render(
            request,
            'vulnerable/_error.html',
            {'error': 'Something went wrong.', 'retry_name': 'profile'}
        )

    return render(request, 'vulnerable/profile.html', {'user': user})

  </code></pre>
</div>
{% endblock %}
