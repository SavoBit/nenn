{% extends "challenge.html" %}

{% block title %}XXE{% endblock %}

{% block body %}
</p>
<p>Here's a buggy XLSX file metadata viewer, and the source used to extract the XLSX
author information. Can you exploit the handler to disclose secret files?
</p>
<fieldset>
  <form class="flex-spread" action="{{ url('xlsx-info') }}" method="POST" enctype="multipart/form-data">
    <input name="file" type="file" />
    <input type="submit" value="Get Info" name="submit">
    <!-- TODO class button here is semantically wrong -->
    <div><a class="button" href="{{ STATIC_URL }}/files/timesheet.xlsx">example</a></div>
    <div><a class="button" href="#just-kidding" title="just kidding">solution</a></div>
    <!-- <div><a class="button" href="{{ STATIC_URL }}/files/timesheet-weaponized.xlsx">weaponized</a></div> -->
    <!-- <div class="flex-item"><a class="button" href="{\{ url('hints/xxe.html') }}">weaponized</a></div> -->
  </form>
</fieldset>

<pre>
    <code>
import xml.sax
import zipfile
    .
    .
    .
class XLSXWorkbookHandler(xml.sax.ContentHandler):
    def __init__(self, result_dict):
        self.res = result_dict
        xml.sax.ContentHandler.__init__(self)
        self.tmp = ''
        self.tmpattrs = None

    def startElement(self, name, attrs):
        self.tmp = ''
        if name == 'sheet':
            self.tmp = attrs.getValue('name')

    def endElement(self, name):
        if name == 'sheet':
            self.res['name'] = self.tmp

    def characters(self, content):
        self.tmp += content


def xlsx_attributes(f):
    '''
    Get the title, creator, creation and modification times, and last
    modifying author for an XLSX.
    '''
    z = zipfile.ZipFile(f)
    props = {}
        .
        .
        .
    with z.open('xl/workbook.xml') as f:
        xml.sax.parse(f, XLSXWorkbookHandler(props))
    return props
    </code>
</pre>
{% endblock %}

{% block extra_scripts %}
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
{% endblock %}
